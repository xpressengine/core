!function(e){"use strict";var t={autoUpload:!0,dataType:"json",sequentialUploads:!0,dropZone:".xefu-dropzone",fileList:".xefu-list",controll:".xefu-controll",filelist:".xefu-list-files ul",filelistImages:".xefu-list-images ul",progressbar:".xefu-progressbar",progressbarGraph:".xefu-progressbar div",progressStatus:".xefu-progress-status",progressPercent:".xefu-progress-percent",actSelectedInsertContent:".xefu-act-link-selected",actSelectedDeleteFile:".xefu-act-delete-selected",actDeleteFile:".xefu-act-delete",actSetCover:".xefu-act-set-cover",tmplXeUploaderFileitem:'<li class="xefu-file xe-clearfix" data-file-srl="{{file_srl}}"><span class="xefu-file-name">{{source_filename}}</span><span class="xefu-file-info"><span>{{disp_file_size}}</span><span><input type="checkbox" data-file-srl="{{file_srl}}"> 선택</span></span></li>',tmplXeUploaderFileitemImage:'<li class="xefu-file xefu-file-image {{#if cover_image}}xefu-is-cover-image{{/if}}" data-file-srl="{{file_srl}}"><strong class="xefu-file-name">{{source_filename}}</strong><span class="xefu-file-info"><span class="xefu-file-size">{{disp_file_size}}</span><span><img src="{{download_url}}" alt=""></span><span><input type="checkbox" data-file-srl="{{file_srl}}"></span><button class="xefu-act-set-cover" data-file-srl="{{file_srl}}" title="커버이미지로 선택"><i class="xi-check-circle"></i></button></span></li>'},i=["fileList","actSelectedInsertContent","actSelectedDeleteFile","actDeleteFile","actSetCover","controll","dropZone","filelist","filelistImages","progressbar","progressbarGraph","progressPercent","progressStatus"],s=xe.createApp("XeUploader",{settings:{},init:function(){},deactivate:function(){},createInstance:function(s,l){var n=this,r=s,a=r.data();e.extend(a,{files:{},selected_files:{},settings:{},last_selected_file:null});var o={url:request_uri.setQuery("module","file").setQuery("act","procFileUpload").setQuery("mid",window.current_mid),formData:{editor_sequence:a.editorSequence,upload_target_srl:a.uploadTargetSrl,mid:window.current_mid,act:"procFileUpload"},dropZone:r,add:function(t,i){var s=jQuery.Deferred();e.each(i.files,function(e,t){return a.settings.maxFileSize<=t.size?(s.reject(),alert(window.xe.msg_exceeds_limit_size),!1):void s.resolve()}),s.done(function(){i.submit()})},done:function(e,t){var i=t.response().result;i&&(jQuery.isPlainObject(i)||(i=jQuery.parseJSON(i)),i&&(0==i.error||alert(i.message)))},stop:function(){n.loadFilelist(r)},start:function(){a.settings.progressbarGraph.width(0),a.settings.progressStatus.show(),a.settings.progressbar.show()},progressall:function(e,t){var i=parseInt(t.loaded/t.total*100,10);a.settings.progressbarGraph.width(i+"%"),a.settings.progressPercent.text(i+"%"),i>=100&&(a.settings.progressbar.delay(3e3).slideUp(),a.settings.progressStatus.delay(3e3).slideUp())}};a.settings=e.extend({},t,o,l||{}),r.data(a),e.each(i,function(e,t){"string"==typeof a.settings[t]&&(a.settings[t]=r.find(a.settings[t]))});r.fileupload(a.settings).prop("disabled",!e.support.fileInput).parent().addClass(e.support.fileInput?void 0:"disabled");r.data("xefu-instance",this),this.loadFilelist(r),a.settings.actSelectedInsertContent.on("click",function(){n.insertToContent(r)}),a.settings.actSelectedDeleteFile.on("click",function(){n.deleteFile(r)});var c=a.settings.fileList.finderSelect({children:"li",enableDesktopCtrlDefault:!0});a.settings.fileList.on("mousedown","img",function(e){e.preventDefault()}),c.finderSelect("addHook","highlight:after",function(e){e.find("input").prop("checked",!0);var t=a.settings.fileList.find("input:checked");a.selected_files=t}),c.finderSelect("addHook","unHighlight:after",function(e){e.find("input").prop("checked",!1);var t=a.settings.fileList.find("input:checked");a.selected_files=t}),c.on("click",":checkbox",function(e){e.preventDefault()}),c.on("click",".xefu-act-set-cover",function(e){e.preventDefault(),n.setCover(r,e.currentTarget)}),e(document).bind("dragover",function(e){var t=window.dropZoneTimeout,i=a.settings.dropZone;t?clearTimeout(t):i.addClass("in");var s=!1,l=e.target;do{if(l===i[0]){s=!0;break}l=l.parentNode}while(null!=l);s?i.addClass("hover"):i.removeClass("hover"),window.dropZoneTimeout=setTimeout(function(){window.dropZoneTimeout=null,i.removeClass("in hover")},100)}),r.data(a)},done:function(){},selectAllFiles:function(){},selectImageFiles:function(){},selectNonImageFiles:function(){},unselectAllFiles:function(){},unselectImageFiles:function(){},unselectNonImageFiles:function(){},insertToContent:function(t){var i="",s=t.data();e.each(s.selected_files,function(t,l){var n=e(l).data().fileSrl,r=s.files[n];r&&(/\.(jpe?g|png|gif)$/i.test(r.download_url)?(i+='<img src="'+window.request_uri+r.download_url+'" alt="'+r.source_filename+'" editor_component="image_link" data-file-srl="'+r.file_srl+'" />',i+="\r\n<p><br></p>\r\n"):i+='<a href="'+window.request_uri+r.download_url+'" data-file-srl="'+r.file_srl+'">'+r.source_filename+"</a>\n")}),_getCkeInstance(s.editorSequence).insertHtml(i,"unfiltered_html")},deleteFile:function(t,i){var s=this,l=[],n=t.data();i?l.push(i):e.each(n.selected_files,function(t,i){if(i){var s=e(i).data().fileSrl;l.push(s)}}),l=l.join(","),exec_json("file.procFileDelete",{file_srls:l,editor_sequence:n.editorSequence},function(){l=l.split(","),e.each(l,function(e,t){n.settings.fileList.find("ul").find("li[data-file-srl="+t+"]").remove()}),s.loadFilelist(t)})},loadFilelist:function(t){var i=t.data(),s={};s.mid=window.current_mid,s.editor_sequence=i.editorSequence,e.exec_json("file.getFileList",s,function(s){console.log(s),i.uploadTargetSrl=s.upload_target_srl,editorRelKeys[i.editorSequence].primary.value=s.upload_target_srl,i.uploadTargetSrl=s.uploadTargetSrl,t.find(".allowed_filetypes").text(s.allowed_filetypes),t.find(".allowed_filesize").text(s.allowed_filesize),t.find(".allowed_attach_size").text(s.allowed_attach_size),t.find(".attached_size").text(s.attached_size),t.find(".file_count").text(s.files.length);var l=i.settings.tmplXeUploaderFileitem,n=i.settings.tmplXeUploaderFileitemImage,r=Handlebars.compile(l),a=Handlebars.compile(n),o=[],c=[];return s.files.length?(e.each(s.files,function(e,s){i.files[s.file_srl]||(i.files[s.file_srl]=s,t.data(i),/\.(jpe?g|png|gif)$/i.test(s.source_filename)?o.push(a(s)):c.push(r(s)))}),i.settings.filelistImages.append(o.join("")),i.settings.filelist.append(c.join("")),i.settings.controll.show(),void i.settings.fileList.show()):(i.settings.fileList.hide(),void i.settings.controll.hide())})},setCover:function(t,i){var s=t.data(),l=e(i),n=l.data().fileSrl;exec_json("file.procFileSetCoverImage",{file_srl:n,mid:window.current_mid,editor_sequence:s.editorSequence},function(e){if(0==e.error){s.settings.filelistImages.find("li").removeClass("xefu-is-cover-image");var t=l.closest("li");t.addClass("xefu-is-cover-image")}})}});e.fn.xeUploader=function(e){var t=new s;return t&&(xe.registerApp(t),t.createInstance(this.eq(0),e)),t}}(jQuery);